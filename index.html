<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Minik Ä°ngilizce â€” Metehan (Firebase)</title>
<link rel="icon" href="data:," />
<style>
  /* --- (TasarÄ±m aynÄ± â€” orijinalinden aldÄ±m, kÄ±salttÄ±m gÃ¶sterim iÃ§in) --- */
  :root{--bg:#fffaf0; --card:#fff; --accent:#ff6b6b; --accent2:#ffd166; --muted:#666; --success:#34c759; --danger:#ff3b30;}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#fffaf0,#f0f7ff);color:#222}
  .app{max-width:980px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column}
  header{display:flex;align-items:center;gap:14px;padding:18px}
  .logo{width:64px;height:64px;border-radius:16px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:22px;box-shadow:0 10px 30px rgba(255,107,107,0.18)}
  h1{margin:0;font-size:20px}
  .muted{color:var(--muted);font-size:13px}
  main{padding:12px;flex:1}
  .card{background:var(--card);border-radius:14px;padding:12px;margin-bottom:12px;box-shadow:0 8px 24px rgba(20,20,40,0.06)}
  .menu{display:flex;gap:8px;overflow:auto;padding:6px 0}
  .menu button{padding:10px 12px;border-radius:12px;border:0;background:#f6f6f6;font-weight:700}
  .menu button.active{background:linear-gradient(90deg,var(--accent),var(--accent2));color:white}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .thumb{border-radius:12px;overflow:hidden;position:relative;border:6px solid transparent;transition:transform .18s, border-color .18s;background:#fafafa;display:flex;align-items:center;justify-content:center}
  .thumb .media{width:100%;height:0;padding-top:70%;position:relative}
  .thumb img{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);max-width:100%;max-height:100%;object-fit:contain;display:block}
  .label{padding:8px;text-align:center;font-weight:800;background:linear-gradient(180deg,rgba(255,255,255,0.6),transparent)}
  .big-btn{width:100%;padding:12px;border-radius:12px;border:0;background:linear-gradient(90deg,var(--accent),#ff8a6b);color:#fff;font-weight:800}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  .outline-green{border-color:var(--success)!important}
  .outline-red{border-color:var(--danger)!important}
  .center{text-align:center}
  input[type=text]{width:100%;padding:10px;border-radius:10px;border:1px solid #eee}
  .small{font-size:12px;color:var(--muted)}
  #previewArea img{max-width:100%;border-radius:12px;margin-top:6px}
  .choice-grid{display:grid;gap:10px;grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));align-items:start;}
  .choice-thumb{border-radius:10px;overflow:hidden;position:relative;background:#fff;border:4px solid transparent;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding:6px;}
  .choice-thumb .media{width:100%;height:0;padding-top:75%;position:relative}
  .choice-thumb img{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);max-width:100%;max-height:100%;object-fit:contain;display:block}
  .choice-thumb .label{margin-top:6px;font-weight:700;font-size:13px;text-align:center;color:#333}
  .choice-thumb.outline-green{border-color:var(--success)}
  .choice-thumb.outline-red{border-color:var(--danger)}
  @media (min-width:900px){ .grid{grid-template-columns:repeat(3,1fr)} .choice-grid{grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));} }
  @media (max-width:480px){ .grid{grid-template-columns:repeat(1,1fr)} .choice-grid{grid-template-columns:repeat(2,1fr)} }
</style>
</head>
<body>
  <div class="app">
    <header>
      <div class="logo">Mi</div>
      <div>
        <h1>Merhaba, METEHAN UZUN! ğŸ‰</h1>
        <div class="muted">Minik Ä°ngilizce â€” Firebase ile paylaÅŸÄ±lan veriler (URL ile resim)</div>
      </div>
    </header>

    <main>
      <div class="card">
        <div class="menu" role="tablist">
          <button id="menu-home" class="active" onclick="navigate('home')">Anasayfa</button>
          <button id="menu-library" onclick="navigate('library')">KÃ¼tÃ¼phane</button>
          <button id="menu-add" onclick="navigate('add')">Kelime Ekle</button>
          <button id="menu-quiz" onclick="navigate('quiz')">Test</button>
          <button id="menu-settings" onclick="navigate('settings')">Ayarlar</button>
        </div>
      </div>

      <div id="view-home" class="card">
        <div class="hero">
          <div style="flex:1">
            <div style="font-weight:800">HoÅŸ geldin Metehan! â­</div>
            <div class="muted">AÅŸaÄŸÄ±daki resimlerden birine tÄ±klayÄ±n; kelime sesli okunacak.</div>
          </div>
          <div style="width:160px">
            <button class="big-btn" onclick="navigate('quiz')" style="background:linear-gradient(90deg,#5bd3ff,#6b8bff)">Hadi Teste BaÅŸla!</button>
          </div>
        </div>
        <div style="margin-top:12px" id="homeGallery" class="grid"></div>
      </div>

      <section id="view-library" class="card" style="display:none">
        <h3>KÃ¼tÃ¼phane</h3>
        <div id="gallery" class="grid" style="margin-top:10px"></div>
      </section>

      <section id="view-add" class="card" style="display:none">
        <h3>Kelime Ekle</h3>
        <div class="muted">Google'dan bulduÄŸun resmin <strong>doÄŸrudan URL</strong>'sini yapÄ±ÅŸtÄ±r. Ã–rnek: https://site.com/image.jpg</div>

        <div style="margin-top:10px">
          <label>Ä°ngilizce kelime</label>
          <input id="wordText" type="text" placeholder="Ã–r: apple" autocomplete="off"/>
        </div>

        <div style="margin-top:8px">
          <label>Resim URL (doÄŸrudan .jpg/.png linki)</label>
          <input id="imgUrlInput" type="text" placeholder="https://...image.jpg" />
          <div style="margin-top:8px">
            <button id="previewUrlBtn" class="big-btn" style="width:auto;display:inline-block;margin-right:8px">Ã–nizle</button>
            <button id="clearPreviewBtn" class="big-btn" style="width:auto;display:inline-block;background:#9b9bff">Temizle</button>
          </div>
        </div>

        <div id="previewArea" style="margin-top:12px"></div>

        <div style="margin-top:12px" class="controls">
          <button id="saveWordBtn" class="big-btn">Kaydet</button>
          <button onclick="navigate('library')" class="big-btn" style="background:#9b9bff">KÃ¼tÃ¼phaneye Git</button>
        </div>
      </section>

      <section id="view-quiz" class="card" style="display:none">
        <h3>Test</h3>
        <div class="muted">Sesle sorulur; doÄŸru fotoÄŸrafÄ± seÃ§.</div>
        <div style="margin-top:8px">
          <button id="startQuizBtn" class="big-btn" style="background:linear-gradient(90deg,#6bffb0,#34c759)">Teste BaÅŸla</button>
        </div>
        <div id="quizArea" style="margin-top:12px"></div>
      </section>

      <section id="view-settings" class="card" style="display:none">
        <h3>Ayarlar</h3>
        <div class="muted">KonuÅŸma dili (kelimelerin telaffuzu iÃ§in)</div>
        <div style="margin-top:8px">
          <label>KonuÅŸma Dili</label>
          <select id="voiceLang" style="width:100%;padding:10px;border-radius:8px;margin-top:6px">
            <option value="en-US" selected>English (US)</option>
            <option value="en-GB">English (UK)</option>
          </select>
        </div>
      </section>
    </main>

    <footer style="padding:12px;text-align:center" class="small muted">
      Uygulama online Firestore kullanÄ±r â€” veriler tÃ¼m cihazlarda paylaÅŸÄ±lÄ±r.
    </footer>
  </div>

<!-- Firebase (compat) SDK'larÄ± â€” bu scriptleri ekleyin -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDRFlEOwV5WuoiOmNAwSyWWOVT73yqrmYs",
  authDomain: "minik-ingilizce.firebaseapp.com",
  projectId: "minik-ingilizce",
  storageBucket: "minik-ingilizce.firebasestorage.app",
  messagingSenderId: "960816468983",
  appId: "1:960816468983:web:7e0e67319f78256208d4f2",
  measurementId: "G-F9REKWSN29"
};
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDRFlEOwV5WuoiOmNAwSyWWOVT73yqrmYs",
  authDomain: "minik-ingilizce.firebaseapp.com",
  projectId: "minik-ingilizce",
  storageBucket: "minik-ingilizce.firebasestorage.app",
  messagingSenderId: "960816468983",
  appId: "1:960816468983:web:7e0e67319f78256208d4f2",
  measurementId: "G-F9REKWSN29"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* --- Global words array (keÅŸke doÄŸrudan onSnapshot kullanalÄ±m) --- */
let words = []; // her dokÃ¼man { id: doc.id, english, imageURL, createdAt }

/* Real-time listener: koleksiyon "words" */
function initFirestore(){
  db.collection('words').orderBy('createdAt', 'desc')
    .onSnapshot(snapshot => {
      const arr = [];
      snapshot.forEach(doc => {
        const data = doc.data();
        arr.push({ id: doc.id, english: data.english, imageURL: data.imageURL, createdAt: data.createdAt });
      });
      // gÃ¼ncelle
      words = arr;
      // UI'Ä± gÃ¼ncelle (mevcut view hangisi olursa)
      renderHomeGallery();
      renderGallery();
    }, err => {
      console.error('Firestore snapshot error', err);
      // hata durumunda kullanÄ±cÄ±ya bildir
    });
}

/* Add word (Firestore) */
async function addWordToFirestore(word, url){
  try {
    const now = Date.now();
    const docRef = await db.collection('words').add({
      english: word,
      imageURL: url,
      createdAt: now
    });
    return { success: true, id: docRef.id };
  } catch(e){
    console.error('addWord err', e);
    return { success: false, error: e };
  }
}

/* Delete word (Firestore) */
async function deleteWordFromFirestore(id){
  try {
    await db.collection('words').doc(id).delete();
    return { success: true };
  } catch(e){
    console.error('delete err', e);
    return { success: false, error: e };
  }
}

/* --- Navigation (aynÄ±) --- */
function navigate(view){
  document.querySelectorAll('.menu button').forEach(b=>b.classList.remove('active'));
  document.getElementById('menu-'+view).classList.add('active');
  ['home','library','add','quiz','settings'].forEach(v=>{
    document.getElementById('view-'+v).style.display = (v===view ? 'block' : 'none');
  });
  if(view === 'home' || view === 'library') { renderHomeGallery(); renderGallery(); }
}

/* Rendering home & library (Firestore kaynaklÄ± words kullanÄ±yor) */
function renderHomeGallery(){
  const el = document.getElementById('homeGallery'); el.innerHTML = '';
  if(!words || words.length === 0){ el.innerHTML = '<div class="muted">HenÃ¼z kelime yok.</div>'; return; }
  words.slice().forEach(w=>{
    const d = document.createElement('div'); d.className='thumb';
    d.innerHTML = `<div class="media"><img src="${escapeHtml(w.imageURL)}" alt="${escapeHtml(w.english)}"></div><div class="label">${escapeHtml(w.english)}</div>`;
    d.onclick = () => {
      speakWord(w.english);
      const badge = document.createElement('div'); badge.style.position='absolute'; badge.style.top='8px'; badge.style.right='8px';
      badge.style.padding='6px 8px'; badge.style.borderRadius='10px'; badge.style.background='rgba(255,255,255,0.9)'; badge.style.fontWeight='800'; badge.innerText='Metehan âœ¨';
      d.appendChild(badge);
      setTimeout(()=>{ badge.remove(); }, 900);
    };
    el.appendChild(d);
  });
}

function renderGallery(){
  const el = document.getElementById('gallery'); el.innerHTML = '';
  if(!words || words.length === 0){ el.innerHTML = '<div class="muted">HenÃ¼z kelime yok.</div>'; return; }
  words.slice().forEach(w=>{
    const d = document.createElement('div'); d.className='thumb';
    d.innerHTML = `<div class="media"><img src="${escapeHtml(w.imageURL)}" alt="${escapeHtml(w.english)}"></div><div class="label">${escapeHtml(w.english)}</div>`;
    const btns = document.createElement('div'); btns.style.display='flex'; btns.style.justifyContent='center'; btns.style.gap='8px'; btns.style.padding='8px';
    const pBtn = document.createElement('button'); pBtn.innerText='ğŸ”Š'; pBtn.style.padding='8px';
    pBtn.onclick = (ev)=>{ ev.stopPropagation(); speakWord(w.english); };
    const delBtn = document.createElement('button'); delBtn.innerText='Sil'; delBtn.style.padding='8px';
    delBtn.onclick = async (ev)=>{
      ev.stopPropagation();
      if(!confirm('Bu kelimeyi silmek istiyor musunuz?')) return;
      const res = await deleteWordFromFirestore(w.id);
      if(!res.success) alert('Silme sÄ±rasÄ±nda hata oluÅŸtu.');
    };
    btns.appendChild(pBtn); btns.appendChild(delBtn); d.appendChild(btns); el.appendChild(d);
  });
}

/* Add by image URL (UI handlers) */
const imgUrlInput = document.getElementById('imgUrlInput');
const previewArea = document.getElementById('previewArea');
const previewBtn = document.getElementById('previewUrlBtn');
const clearPreviewBtn = document.getElementById('clearPreviewBtn');
const saveBtn = document.getElementById('saveWordBtn');

previewBtn.addEventListener('click', ()=> {
  const url = (imgUrlInput.value || '').trim(); previewArea.innerHTML = '';
  if(!url){ previewArea.innerHTML = '<div class="muted">LÃ¼tfen geÃ§erli bir URL girin.</div>'; return; }
  const img = document.createElement('img'); img.src = url; img.alt = 'preview';
  img.onerror = () => { previewArea.innerHTML = '<div class="muted">Resim yÃ¼klenemiyor (CORS veya hatalÄ± URL olabilir).</div>'; };
  previewArea.appendChild(img);
});

clearPreviewBtn.addEventListener('click', ()=> { imgUrlInput.value = ''; previewArea.innerHTML = ''; });

saveBtn.addEventListener('click', async ()=> {
  const word = (document.getElementById('wordText').value || '').trim();
  const url = (imgUrlInput.value || '').trim();
  if(!word){ alert('Ä°ngilizce kelime girin.'); return; }
  if(!url){ alert('Resim URL girin.'); return; }
  if(!/^https?:\/\//i.test(url)){ alert('GeÃ§erli bir http veya https URL girin.'); return; }

  // Firestore'a ekle
  const res = await addWordToFirestore(word, url);
  if(!res.success){ alert('Kaydetme sÄ±rasÄ±nda hata oluÅŸtu.'); return; }
  document.getElementById('wordText').value = ''; imgUrlInput.value = ''; previewArea.innerHTML = '<div class="small">Kaydedildi âœ“</div>';
  setTimeout(()=>{ navigate('library'); }, 700);
});

/* ---------- TTS helpers with Promise (aynÄ±) ---------- */
function speakWithLangPromise(text, lang='tr-TR', rate=0.95){
  return new Promise((resolve) => {
    if(!('speechSynthesis' in window)){ resolve(); return; }
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = lang;
    u.rate = rate;
    u.onend = () => resolve();
    u.onerror = () => resolve();
    window.speechSynthesis.speak(u);
  });
}
function speakWord(text){
  const lang = document.getElementById('voiceLang').value || 'en-US';
  speakWithLangPromise(text, lang); // fire-and-forget
}
async function speakFeedbackAsync(text, repeats=1, delay=700){
  await speakWithLangPromise(text, 'tr-TR');
  for(let i=1;i<repeats;i++){
    await new Promise(r => setTimeout(r, delay));
    await speakWithLangPromise(text, 'tr-TR');
  }
}

/* ---------- Quiz logic (kÃ¼Ã§Ã¼k deÄŸiÅŸiklik id'ler Firestore ids) ---------- */
let currentQuiz = null;
document.getElementById('startQuizBtn').addEventListener('click', startQuiz);

function startQuiz(){
  if(!words || words.length === 0){ alert('Ã–nce kelime ekleyin.'); return; }
  const questions = shuffle([...words]);
  currentQuiz = { questions, index: 0, results: [] };
  renderQuizQuestion();
}

function renderQuizQuestion(){
  const qObj = currentQuiz.questions[currentQuiz.index];
  const qArea = document.getElementById('quizArea'); qArea.innerHTML = '';
  const decoys = words.filter(w=>w.id !== qObj.id);
  const pick = shuffle(decoys).slice(0,4);
  const choices = shuffle([qObj, ...pick]);

  qArea.innerHTML = `<div class="center" style="font-weight:800">Soru ${currentQuiz.index+1} / ${currentQuiz.questions.length}</div>
    <div style="margin-top:10px" class="center"><button id="playWordBtn" class="big-btn" style="background:linear-gradient(90deg,#ffd166,#ff6b6b)">ğŸ”Š Dinle</button></div>`;
  document.getElementById('playWordBtn').addEventListener('click', ()=> { speakWord(qObj.english); });
  setTimeout(()=> speakWord(qObj.english), 250);

  const grid = document.createElement('div'); grid.className='choice-grid'; grid.style.marginTop='12px';

  choices.forEach(choice=>{
    const w = document.createElement('div'); w.className='choice-thumb';
    w.innerHTML = `<div class="media"><img src="${escapeHtml(choice.imageURL)}" alt=""></div><div class="label"></div>`;

    w.addEventListener('click', async function handler(){
      if(w.dataset.answered) return;
      w.dataset.answered = '1';
      Array.from(grid.querySelectorAll('.choice-thumb')).forEach(t => t.style.pointerEvents='none');

      const correct = (choice.id === qObj.id);

      if(correct){
        w.classList.add('outline-green');
        await speakFeedbackAsync('Tebrikler Metehan, doÄŸru cevap!', 1, 700);
      } else {
        w.classList.add('outline-red');
        await speakFeedbackAsync('YanlÄ±ÅŸ, Metehan. Tekrar dene.', 2, 700);
      }

      currentQuiz.results.push({ qid: qObj.id, correct });

      Array.from(grid.querySelectorAll('.choice-thumb')).forEach(t => t.style.pointerEvents='auto');

      setTimeout(()=> {
        if(currentQuiz.index + 1 < currentQuiz.questions.length){
          currentQuiz.index++;
          renderQuizQuestion();
        } else {
          showQuizSummaryWithSpeech();
        }
      }, 250);
    });

    grid.appendChild(w);
  });

  qArea.appendChild(grid);
}

async function showQuizSummaryWithSpeech(){
  const area = document.getElementById('quizArea');
  const correctCount = currentQuiz.results.filter(r=>r.correct).length;
  const total = currentQuiz.results.length;
  const wrong = total - correctCount;

  area.innerHTML = `<div class="center"><h3>Tebrikler! Test bitti ğŸ‰</h3>
    <div style="font-size:18px;font-weight:800">${correctCount} / ${total} doÄŸru</div>
    <div style="margin-top:12px"><button onclick="startQuiz()" class="big-btn" style="background:linear-gradient(90deg,#6bffb0,#34c759)">Tekrar Dene</button></div>
    <div style="margin-top:8px"><button onclick="navigate('library')" class="big-btn" style="background:#9b9bff">KÃ¼tÃ¼phaneye DÃ¶n</button></div></div>`;

  const summary = `Test bitti. ${correctCount} doÄŸru, ${wrong} yanlÄ±ÅŸ.`;
  await speakWithLangPromise(summary, 'tr-TR');
  await new Promise(r => setTimeout(r, 500));
  if(correctCount > wrong){
    await speakWithLangPromise('Tebrikler Metehan! Ã‡ok iyi iÅŸ Ã§Ä±kardÄ±n!', 'tr-TR');
  } else if (correctCount === wrong){
    await speakWithLangPromise('Ä°yi bir deneme Metehan, tekrar et, daha da iyi olacaksÄ±n!', 'tr-TR');
  } else {
    await speakWithLangPromise('Bir dahaki sefer daha iyi olacak, tekrar dene Metehan!', 'tr-TR');
  }

  currentQuiz = null;
}

/* Helpers */
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] } return arr; }
function escapeForJS(str){ return (str||'').replace(/'/g,"\\'").replace(/"/g,'\\"'); }
function escapeHtml(s){ return (s||'').replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"); }

/* Init */
document.getElementById('startQuizBtn').addEventListener('click', startQuiz);
navigate('home');
initFirestore(); // Firestore baÄŸlantÄ±sÄ±nÄ± baÅŸlatÄ±p onSnapshot dinleyicisini kurar
</script>
</body>
</html>